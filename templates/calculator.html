<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Retirement Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* All your CSS styles go here... */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0;
        }
        .form-section {
            padding: 40px;
            background: #f8f9fa;
            overflow-y: auto;
            max-height: 90vh;
        }
        .results-section {
            padding: 40px;
            background: white;
        }
        .form-group {
            margin-bottom: 25px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
        }
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .section-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            font-weight: 600;
        }
        /* Asset Allocation Styles */
        .asset-allocation-section {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #e8f0fe;
        }
        .allocation-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .slider-group {
            display: flex;
            flex-direction: column;
        }
        .slider-container {
            position: relative;
            margin: 15px 0;
        }
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            margin: 10px 0;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        .slider-value {
            position: absolute;
            top: -30px;
            right: 0;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        /* Investment Streams Styles */
        .investment-streams-section {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #e8f0fe;
        }
        .investment-stream {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
            position: relative;
        }
        .stream-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .stream-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }
        .remove-stream {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .stream-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .add-stream-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 15px;
            width: 100%;
        }
        .calculate-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .calculate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        .results {
            display: block; /* results now live inside the output screen */
        }
        .results.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Fullscreen output screen */
        .output-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        .output-screen.open {
            display: flex;
            animation: fadeIn 0.25s ease;
        }
        .output-inner {
            background: white;
            width: 100%;
            max-width: 1100px;
            height: 90vh;
            border-radius: 12px;
            overflow: auto;
            padding: 28px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-output {
            position: sticky;
            top: 10px;
            left: 10px;
            background: transparent;
            border: none;
            color: #34495e;
            font-weight: 700;
            cursor: pointer;
            font-size: 1em;
            padding: 8px 12px;
            border-radius: 8px;
        }
        .output-content {
            margin-top: 10px;
        }
        /* Tabs */
        .tab {
            background: #edf2ff;
            border: 1px solid #e2e8f0;
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            letter-spacing: 0.2px;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.18);
        }
        .small-btn {
            background: #4a5568;
            color: white;
            padding: 6px 8px;
            font-size: 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        .small-btn:hover { filter: brightness(0.95); }
        /* Table styles */
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .detail-table thead th {
            position: sticky;
            top: 0;
            background: #ffffff;
            border-bottom: 1px solid #e6e6e6;
            padding: 8px 10px;
            text-align: left;
            font-weight: 700;
        }
        .detail-table tbody td {
            padding: 8px 10px;
            border-bottom: 1px solid #f1f1f1;
        }
        .table-toolbar {
            display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-bottom:10px;
        }
        .result-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        .result-highlight {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .percentile-results {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        .percentile-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        .success {
            color: #27ae60;
        }
        .warning {
            color: #f39c12;
        }
        .danger {
            color: #e74c3c;
        }
        .chart-container {
            margin-top: 30px;
            text-align: center;
        }
        .chart-container img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .loading.show {
            display: block;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            display: none;
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .error.show {
            display: block;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: #667eea;
            margin-left: 5px;
        }
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            max-width: 200px;
            white-space: normal;
        }
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .form-row, .allocation-controls, .stream-controls, .percentile-results {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2em;
            }
            .form-section, .results-section {
                padding: 20px;
            }
            .container {
                max-width: 100%;
                margin: 0;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enhanced Retirement Calculator</h1>
            <p>Comprehensive retirement planning with Monte Carlo simulation, asset allocation, and multiple investment streams</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <form id="calculatorForm">
                    <div class="section-title">Personal Information</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="age_current">Current Age <span class="tooltip" data-tooltip="Your current age">ℹ</span></label>
                            <input type="number" id="age_current" name="age_current" value="45" min="25" max="70" required>
                        </div>
                        <div class="form-group">
                            <label for="age_retire">Retirement Age <span class="tooltip" data-tooltip="Age when you plan to retire">ℹ</span></label>
                            <input type="number" id="age_retire" name="age_retire" value="65" min="55" max="75" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="life_expectancy">Life Expectancy <span class="tooltip" data-tooltip="Expected lifespan for planning purposes">ℹ</span></label>
                        <input type="number" id="life_expectancy" name="life_expectancy" value="90" min="70" max="100" required>
                    </div>
                    
                    <div class="section-title">Financial Information</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="portfolio_total">Current Portfolio ($) <span class="tooltip" data-tooltip="Total current retirement savings">ℹ</span></label>
                            <input type="number" id="portfolio_total" name="portfolio_total" value="500000" min="0" step="1000" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="years_contributing">Years Contributing <span class="tooltip" data-tooltip="How many more years you'll contribute">ℹ</span></label>
                            <input type="number" id="years_contributing" name="years_contributing" value="20" min="0" max="40" required>
                        </div>
                        <div class="form-group">
                            <label for="monthly_benefit_income">Monthly Benefits ($) <span class="tooltip" data-tooltip="Expected Social Security and pension income">ℹ</span></label>
                            <input type="number" id="monthly_benefit_income" name="monthly_benefit_income" value="2000" min="0" step="100" required>
                        </div>
                    </div>

                    <div class="asset-allocation-section">
                        <div class="section-title">Asset Allocation & Risk Parameters</div>
                        <div class="allocation-controls">
                            <div class="slider-group">
                                <label>Stock Allocation: <span id="stock-value">70</span>%</label>
                                <div class="slider-container">
                                    <input type="range" id="stock_allocation" name="stock_allocation" min="0" max="100" value="70" class="slider">
                                </div>
                            </div>
                            <div class="slider-group">
                                <label>Bond Allocation: <span id="bond-value">30</span>%</label>
                                <div class="slider-container">
                                    <input type="range" id="bond_allocation" name="bond_allocation" min="0" max="100" value="30" class="slider">
                                </div>
                            </div>
                        </div>
                        <div class="allocation-controls">
                            <div class="slider-group">
                                <label>Stock Volatility: <span id="stock-vol-value">16</span>%</label>
                                <div class="slider-container">
                                    <input type="range" id="stock_volatility" name="stock_volatility" min="10" max="25" value="16" class="slider">
                                </div>
                            </div>
                            <div class="slider-group">
                                <label>Bond Volatility: <span id="bond-vol-value">5</span>%</label>
                                <div class="slider-container">
                                    <input type="range" id="bond_volatility" name="bond_volatility" min="2" max="10" value="5" class="slider">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Asset Correlation: <span id="correlation-value">-10</span>%</label>
                            <div class="slider-container">
                                <input type="range" id="correlation" name="correlation" min="-50" max="50" value="-10" class="slider">
                            </div>
                        </div>
                    </div>

                    <div class="investment-streams-section">
                        <div class="section-title">Multiple Investment Streams</div>
                        <p style="margin-bottom: 20px; color: #666; font-size: 0.9em;">
                            Add multiple investment accounts with different tax treatments and limits. 
                            Define your annual contributions using investment streams below; if none are provided, no recurring contributions are assumed.
                        </p>
                        <div id="investment-streams-container">
                            </div>
                        <button type="button" class="add-stream-btn" onclick="addInvestmentStream()">
                            + Add Investment Stream
                        </button>
                    </div>
                    
                    <div class="section-title">Budget and Expenses</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="current_monthly_budget">Current Monthly Budget ($) <span class="tooltip" data-tooltip="Your current monthly living expenses">ℹ</span></label>
                            <input type="number" id="current_monthly_budget" name="current_monthly_budget" value="5000" min="1000" step="100" required>
                        </div>
                        <div class="form-group">
                            <label for="retirement_budget_ratio">Retirement Budget Ratio (%) <span class="tooltip" data-tooltip="Percentage of current budget needed in retirement">ℹ</span></label>
                            <input type="number" id="retirement_budget_ratio" name="retirement_budget_ratio" value="80" min="50" max="120" step="5" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="healthcare_costs">Monthly Healthcare Costs ($) <span class="tooltip" data-tooltip="Expected monthly healthcare expenses in retirement">ℹ</span></label>
                        <input type="number" id="healthcare_costs" name="healthcare_costs" value="500" min="200" max="2000" step="50" required>
                    </div>
                    
                    <div class="section-title">Investment Parameters</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expected_return">Expected Annual Return (%) <span class="tooltip" data-tooltip="Expected annual portfolio return">ℹ</span></label>
                            <input type="number" id="expected_return" name="expected_return" value="7.0" min="2" max="12" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="inflation_rate">Inflation Rate (%) <span class="tooltip" data-tooltip="Expected annual inflation rate">ℹ</span></label>
                            <input type="number" id="inflation_rate" name="inflation_rate" value="2.5" min="1" max="5" step="0.1" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="account_type">Primary Account Type <span class="tooltip" data-tooltip="Primary account type for tax calculations">ℹ</span></label>
                            <select id="account_type" name="account_type" required>
                                <option value="Roth IRA/401k">Roth IRA/401k</option>
                                <option value="Traditional IRA/401k">Traditional IRA/401k</option>
                                <option value="Taxable Account">Taxable Account</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tax_rate">Effective Tax Rate (%) <span class="tooltip" data-tooltip="Expected tax rate on withdrawals">ℹ</span></label>
                            <input type="number" id="tax_rate" name="tax_rate" value="22" min="0" max="40" step="1" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="retirement_phases">Spending Pattern <span class="tooltip" data-tooltip="How your spending may change throughout retirement">ℹ</span></label>
                        <select id="retirement_phases" name="retirement_phases" required>
                            <option value="Constant">Constant Spending</option>
                            <option value="Early Active">Early Active (Higher spending first 10 years)</option>
                            <option value="Late Increase">Late Increase (Higher spending in later years)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="calculate-btn">Calculate Enhanced Retirement Plan</button>
                </form>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Running advanced Monte Carlo simulation with asset allocation modeling...</p>
                </div>

                <div class="error" id="errorMessage"></div>
            </div>
            
            <div class="results-section">
                <div class="results-placeholder">
                    <p style="padding:40px; text-align:center; color:#666;">Results will open on a full-screen output screen after the calculation completes. Use the back button on the output screen to return to inputs and run another simulation.</p>
                </div>
            </div>
        </div>

        <!-- Fullscreen output screen -->
        <div class="output-screen" id="outputScreen" aria-hidden="true">
            <div class="output-inner">
                <button id="closeOutput" class="close-output">← Back to Inputs</button>
                <div class="output-content">
                    <div class="tabs" role="tablist" aria-label="Result tabs" style="display:flex; gap:12px; align-items:center;">
                        <button id="tabSummary" class="tab active" role="tab" aria-selected="true">Summary</button>
                        <button id="tabDetails" class="tab" role="tab">Details</button>
                        <div style="flex:1"></div>
                        <button id="downloadAllCsv" class="small-btn">Download All CSVs</button>
                    </div>

                    <div id="tabSummaryContent">
                        <!-- Summary content (moved from previous results) -->
                        <div class="results" id="results">
                            <div class="section-title">Enhanced Retirement Analysis Results</div>

                            <div class="result-card">
                                <div class="result-highlight" id="portfolioResult"></div>
                                <div id="portfolioDetails"></div>
                            </div>

                            <div class="result-card">
                                <div class="result-highlight">Monte Carlo Success Probability</div>
                                <div id="successProbability" class="result-highlight"></div>
                                <p>Based on 10,000 simulations with correlated asset returns and volatility modeling</p>
                            </div>

                            <div class="result-card">
                                <div class="result-highlight">Portfolio Value Percentiles</div>
                                <div class="percentile-results">
                                    <div class="percentile-card">
                                        <strong>10th Percentile</strong>
                                        <div id="percentile10" class="result-highlight"></div>
                                    </div>
                                    <div class="percentile-card">
                                        <strong>50th Percentile</strong>
                                        <div id="percentile50" class="result-highlight"></div>
                                    </div>
                                    <div class="percentile-card">
                                        <strong>90th Percentile</strong>
                                        <div id="percentile90" class="result-highlight"></div>
                                    </div>
                                </div>
                                <p>Final portfolio values from successful scenarios</p>
                            </div>

                            <div class="result-card">
                                <div class="result-highlight">Asset Allocation Summary</div>
                                <div id="assetAllocation"></div>
                            </div>

                            <div class="result-card">
                                <div class="result-highlight">Key Projections</div>
                                <div id="keyProjections"></div>
                            </div>

                            <div class="chart-container">
                                <h3>Comprehensive Analysis Charts</h3>
                                <p style="margin-bottom: 20px; color: #666;">
                                    Includes probability distribution, asset allocation breakdown, and withdrawal rate analysis
                                </p>
                                <img id="chartImage" src="" alt="Enhanced Retirement Analysis Charts" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <div id="tabDetailsContent" style="display:none;">
                        <div class="section-title">Year-by-Year Details</div>

                        <div class="result-card">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <strong>Pre-Retirement (Accumulation)</strong>
                                <div style="display:flex; gap:8px;">
                                    <button class="calculate-btn" id="preShowToggle" style="padding:6px 10px; font-size:14px;">Show all</button>
                                    <button class="small-btn" id="preCsv">Download CSV</button>
                                </div>
                            </div>
                            <div id="preTableContainer" style="max-height:340px; overflow:auto; border-radius:8px;"></div>
                        </div>

                        <div class="result-card">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <strong>Retirement (Decumulation)</strong>
                                <div style="display:flex; gap:8px;">
                                    <button class="calculate-btn" id="retShowToggle" style="padding:6px 10px; font-size:14px;">Show all</button>
                                    <button class="small-btn" id="retCsv">Download CSV</button>
                                </div>
                            </div>
                            <div id="retTableContainer" style="max-height:340px; overflow:auto; border-radius:8px;"></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let streamCounter = 0;

        // Asset allocation slider handlers
        function setupSliders() {
            const stockSlider = document.getElementById('stock_allocation');
            const bondSlider = document.getElementById('bond_allocation');
            const stockVolSlider = document.getElementById('stock_volatility');
            const bondVolSlider = document.getElementById('bond_volatility');
            const correlationSlider = document.getElementById('correlation');

            stockSlider.addEventListener('input', function() {
                document.getElementById('stock-value').textContent = this.value;
                bondSlider.value = 100 - this.value;
                document.getElementById('bond-value').textContent = bondSlider.value;
            });

            bondSlider.addEventListener('input', function() {
                document.getElementById('bond-value').textContent = this.value;
                stockSlider.value = 100 - this.value;
                document.getElementById('stock-value').textContent = stockSlider.value;
            });

            stockVolSlider.addEventListener('input', function() {
                document.getElementById('stock-vol-value').textContent = this.value;
            });

            bondVolSlider.addEventListener('input', function() {
                document.getElementById('bond-vol-value').textContent = this.value;
            });

            correlationSlider.addEventListener('input', function() {
                document.getElementById('correlation-value').textContent = this.value;
            });
        }

        function addInvestmentStream() {
            streamCounter++;
            const container = document.getElementById('investment-streams-container');
            
            const streamDiv = document.createElement('div');
            streamDiv.className = 'investment-stream';
            streamDiv.id = `stream-${streamCounter}`;
            
            streamDiv.innerHTML = `
                <div class="stream-header">
                    <input type="text" placeholder="Stream Name (e.g., Roth IRA)" class="stream-name-input" 
                           style="border: none; background: transparent; font-weight: 600; font-size: 1.1em; color: #2c3e50;">
                    <button type="button" class="remove-stream" onclick="removeInvestmentStream('stream-${streamCounter}')">Remove</button>
                </div>
                <div class="stream-controls">
                    <div class="form-group">
                        <label>Annual Contribution ($)</label>
                        <input type="number" class="stream-contribution" min="0" step="100" value="6500">
                    </div>
                    <div class="form-group">
                        <label>Tax Treatment</label>
                        <select class="stream-tax-treatment">
                            <option value="roth">Roth (Tax-Free)</option>
                            <option value="traditional">Traditional (Tax-Deferred)</option>
                            <option value="taxable">Taxable</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Contribution Limit ($)</label>
                        <input type="number" class="stream-limit" min="0" step="100" value="6500">
                    </div>
                    <div class="form-group">
                        <label>Employer Match Rate (%)</label>
                        <input type="number" class="stream-match-rate" min="0" max="100" step="1" value="0">
                    </div>
                </div>
            `;
            
            container.appendChild(streamDiv);
        }

        function removeInvestmentStream(streamId) {
            const stream = document.getElementById(streamId);
            if (stream) {
                stream.remove();
            }
        }

        function collectInvestmentStreams() {
            const streams = [];
            const streamElements = document.querySelectorAll('.investment-stream');
            
            streamElements.forEach(stream => {
                const name = stream.querySelector('.stream-name-input').value || 'Unnamed Stream';
                const contribution = parseFloat(stream.querySelector('.stream-contribution').value) || 0;
                const taxTreatment = stream.querySelector('.stream-tax-treatment').value;
                const limit = parseFloat(stream.querySelector('.stream-limit').value) || contribution;
                const matchRate = parseFloat(stream.querySelector('.stream-match-rate').value) || 0;
                
                streams.push({
                    name: name,
                    annual_contribution: contribution,
                    tax_treatment: taxTreatment,
                    contribution_limit: limit,
                    employer_match_rate: matchRate / 100,
                    employer_match_limit: contribution * (matchRate / 100) * 2 // Assume 2x contribution as max match
                });
            });
            
            return streams;
        }

        // Form submission
        document.getElementById('calculatorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading, hide any open output screen and errors
            document.getElementById('loading').classList.add('show');
            const outputScreen = document.getElementById('outputScreen');
            if (outputScreen) {
                outputScreen.classList.remove('open');
                outputScreen.setAttribute('aria-hidden', 'true');
            }
            document.getElementById('errorMessage').classList.remove('show');
            
            // Collect form data
            const formData = new FormData(this);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Add investment streams
            data.investment_streams = collectInvestmentStreams();
            
            try {
                const response = await fetch('/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                // Hide loading
                document.getElementById('loading').classList.remove('show');
                
                if (result.success) {
                    displayResults(result.results);
                } else {
                    showError(result.error);
                }
            } catch (error) {
                document.getElementById('loading').classList.remove('show');
                showError('Network error: ' + error.message);
            }
        });
        
        function displayResults(results) {
            // Portfolio survival result
            const portfolioResult = document.getElementById('portfolioResult');
            const portfolioDetails = document.getElementById('portfolioDetails');
            
            if (results.portfolio_survives) {
                portfolioResult.className = 'result-highlight success';
                portfolioResult.textContent = '✓ Portfolio Survives to Life Expectancy';
                portfolioDetails.innerHTML = `
                    <p><strong>Final Portfolio Value:</strong> ${results.final_portfolio}</p>
                    <p>Your retirement savings are projected to last throughout your expected lifetime.</p>
                `;
            } else {
                portfolioResult.className = 'result-highlight danger';
                portfolioResult.textContent = '⚠ Portfolio Depleted';
                portfolioDetails.innerHTML = `
                    <p><strong>Portfolio depleted at age:</strong> ${results.depletion_age}</p>
                    <p>Consider increasing savings, reducing expenses, or adjusting retirement age.</p>
                `;
            }
            
            // Success probability
            const successProb = parseFloat(results.success_probability);
            const successElement = document.getElementById('successProbability');
            
            if (successProb >= 80) {
                successElement.className = 'result-highlight success';
            } else if (successProb >= 60) {
                successElement.className = 'result-highlight warning';
            } else {
                successElement.className = 'result-highlight danger';
            }
            successElement.textContent = results.success_probability;
            
            // Percentile results
            if (results.percentiles) {
                document.getElementById('percentile10').textContent = results.percentiles['10th_percentile'];
                document.getElementById('percentile50').textContent = results.percentiles['50th_percentile'];
                document.getElementById('percentile90').textContent = results.percentiles['90th_percentile'];
            }
            
            // Asset allocation summary
            if (results.asset_allocation) {
                document.getElementById('assetAllocation').innerHTML = `
                    <p><strong>Stock Allocation:</strong> ${results.asset_allocation.stocks}</p>
                    <p><strong>Bond Allocation:</strong> ${results.asset_allocation.bonds}</p>
                    <p>Portfolio volatility is driven by this asset mix and market correlation modeling.</p>
                `;
            }
            
            // Key projections
            document.getElementById('keyProjections').innerHTML = `
                <p><strong>Portfolio at Retirement:</strong> ${results.future_portfolio}</p>
                <p><strong>Years Until Retirement:</strong> ${results.years_until_retirement}</p>
                <p><strong>Years in Retirement:</strong> ${results.retirement_years}</p>
                <p><strong>Initial Monthly Budget:</strong> ${results.initial_monthly_budget}</p>
            `;
            
            // Display chart
            if (results.chart) {
                const chartImg = document.getElementById('chartImage');
                chartImg.src = 'data:image/png;base64,' + results.chart;
                chartImg.style.display = 'block';
            }
            
            // Show results on full-screen output
            const outputScreen = document.getElementById('outputScreen');
            if (outputScreen) {
                outputScreen.setAttribute('aria-hidden', 'false');
                outputScreen.classList.add('open');
                // Ensure inner content is at the top
                const inner = outputScreen.querySelector('.output-inner');
                if (inner) inner.scrollTop = 0;
            }

            // Save results for details tab rendering
            window._calculatorResults = results;
            renderDetails(results.details || {pre_retirement: [], retirement: []});
            switchTab('summary');
        
        // --- Details rendering helpers ------------------------------------------------
        function switchTab(name) {
            const summaryBtn = document.getElementById('tabSummary');
            const detailsBtn = document.getElementById('tabDetails');
            const summaryContent = document.getElementById('tabSummaryContent');
            const detailsContent = document.getElementById('tabDetailsContent');

            if (name === 'summary') {
                summaryBtn.classList.add('active');
                summaryBtn.setAttribute('aria-selected', 'true');
                detailsBtn.classList.remove('active');
                summaryContent.style.display = '';
                detailsContent.style.display = 'none';
            } else {
                detailsBtn.classList.add('active');
                detailsBtn.setAttribute('aria-selected', 'true');
                summaryBtn.classList.remove('active');
                summaryContent.style.display = 'none';
                detailsContent.style.display = '';
            }
        }

        document.getElementById('tabSummary').addEventListener('click', () => switchTab('summary'));
        document.getElementById('tabDetails').addEventListener('click', () => switchTab('details'));

        function renderDetails(details) {
            // details: { pre_retirement: [...], retirement: [...] }
            const preData = details.pre_retirement || [];
            const retData = details.retirement || [];

            // Render preview (first 10) tables
            renderTable('preTableContainer', preData, ['Year', 'Age', 'Beginning_Portfolio', 'Yearly_Contribution', 'Tax_Savings', 'Ending_Portfolio'], 10);
            renderTable('retTableContainer', retData, ['Year', 'Age', 'Beginning_Portfolio', 'Withdrawal', 'Investment_Return', 'Ending_Portfolio', 'Annual_Budget', 'Healthcare_Costs', 'Withdrawal_Rate'], 10);

            // Wire buttons
            document.getElementById('preShowToggle').addEventListener('click', function() {
                toggleShowAll('preTableContainer', preData, ['Year', 'Age', 'Beginning_Portfolio', 'Yearly_Contribution', 'Tax_Savings', 'Ending_Portfolio'], this);
            });
            document.getElementById('retShowToggle').addEventListener('click', function() {
                toggleShowAll('retTableContainer', retData, ['Year', 'Age', 'Beginning_Portfolio', 'Withdrawal', 'Investment_Return', 'Ending_Portfolio', 'Annual_Budget', 'Healthcare_Costs', 'Withdrawal_Rate'], this);
            });
            document.getElementById('preCsv').addEventListener('click', function() { downloadCSV('pre_retirement.csv', preData); });
            document.getElementById('retCsv').addEventListener('click', function() { downloadCSV('retirement.csv', retData); });
            document.getElementById('downloadAllCsv').addEventListener('click', function() { downloadCSV('pre_retirement.csv', preData); downloadCSV('retirement.csv', retData); });
        }

        function renderTable(containerId, data, columns, limit) {
            const container = document.getElementById(containerId);
            const rows = (typeof limit === 'number') ? data.slice(0, limit) : data;
            const table = document.createElement('table');
            table.className = 'detail-table';

            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
            columns.forEach(c => {
                const th = document.createElement('th');
                th.textContent = c.replace(/_/g, ' ');
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            rows.forEach(r => {
                const tr = document.createElement('tr');
                columns.forEach(c => {
                    const td = document.createElement('td');
                    let val = r[c] !== undefined ? r[c] : '';
                    if (typeof val === 'number') {
                        // format currency for amounts and % for rates
                        if (c.toLowerCase().includes('rate')) {
                            td.textContent = (val * 100).toFixed(1) + '%';
                        } else if (c.toLowerCase().includes('percent') || c.toLowerCase().includes('allocation')) {
                            td.textContent = val;
                        } else {
                            td.textContent = '$' + Number(val).toLocaleString(undefined, {maximumFractionDigits:0});
                        }
                    } else {
                        td.textContent = val;
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            // Clear container and append
            container.innerHTML = '';
            container.appendChild(table);
        }

        function toggleShowAll(containerId, data, columns, btn) {
            const showingAll = btn.dataset.showing === '1';
            if (showingAll) {
                renderTable(containerId, data, columns, 10);
                btn.textContent = 'Show all';
                btn.dataset.showing = '0';
            } else {
                renderTable(containerId, data, columns, null);
                btn.textContent = 'Show first 10';
                btn.dataset.showing = '1';
            }
        }

        function downloadCSV(filename, data) {
            if (!data || !data.length) {
                alert('No data to download');
                return;
            }
            const keys = Object.keys(data[0]);
            const lines = [keys.join(',')].concat(data.map(r => keys.map(k => JSON.stringify(r[k] === undefined ? '' : r[k])).join(',')));
            const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = 'Error: ' + message;
            errorElement.classList.add('show');
        }
        
        // Form validation and dependencies
        function updateFormValidation() {
            const currentAge = parseInt(document.getElementById('age_current').value);
            const retireAge = parseInt(document.getElementById('age_retire').value);
            const lifeExpectancy = parseInt(document.getElementById('life_expectancy').value);
            
            // Ensure retirement age is after current age
            if (retireAge <= currentAge) {
                document.getElementById('age_retire').value = currentAge + 1;
            }
            
            // Ensure life expectancy is after retirement age
            if (lifeExpectancy <= retireAge) {
                document.getElementById('life_expectancy').value = retireAge + 1;
            }
        }
        
        // Add event listeners for form validation
        document.getElementById('age_current').addEventListener('change', updateFormValidation);
        document.getElementById('age_retire').addEventListener('change', updateFormValidation);
        document.getElementById('life_expectancy').addEventListener('change', updateFormValidation);
        
        // Tax rate visibility based on account type
        document.getElementById('account_type').addEventListener('change', function() {
            const taxRateGroup = document.getElementById('tax_rate').parentElement;
            if (this.value === 'Roth IRA/401k') {
                taxRateGroup.style.opacity = '0.5';
                document.getElementById('tax_rate').value = '0';
            } else {
                taxRateGroup.style.opacity = '1';
                if (document.getElementById('tax_rate').value === '0') {
                    document.getElementById('tax_rate').value = '22';
                }
            }
        });

        // Add sample investment streams on page load
        function addSampleStreams() {
            // Add Roth IRA stream
            addInvestmentStream();
            const firstStream = document.querySelector('.investment-stream:last-child');
            firstStream.querySelector('.stream-name-input').value = 'Roth IRA';
            firstStream.querySelector('.stream-contribution').value = '6500';
            firstStream.querySelector('.stream-tax-treatment').value = 'roth';
            firstStream.querySelector('.stream-limit').value = '6500';

            // Add 401k stream
            addInvestmentStream();
            const secondStream = document.querySelector('.investment-stream:last-child');
            secondStream.querySelector('.stream-name-input').value = '401k Traditional';
            secondStream.querySelector('.stream-contribution').value = '18500';
            secondStream.querySelector('.stream-tax-treatment').value = 'traditional';
            secondStream.querySelector('.stream-limit').value = '22500';
            secondStream.querySelector('.stream-match-rate').value = '50';
        }
        
        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupSliders();
            updateFormValidation();

            // Optional: pre-fill sample streams (uncomment if desired)
            // addSampleStreams();

            // Close output screen handler
            const closeBtn = document.getElementById('closeOutput');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    const output = document.getElementById('outputScreen');
                    if (output) {
                        output.classList.remove('open');
                        output.setAttribute('aria-hidden', 'true');
                    }
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }

        });
    </script>
</body>
</html>
